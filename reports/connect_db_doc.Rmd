---
title: "Database Connection Script"
author: "MMM Arachchi"
date: "2025-09-21"
version: 1
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

### Purpose

The purpose of this script is to connect to a PostgreSQL database, verify the connection, and provide helper functions to run queries safely from R.

### Pre-requisites:

- R and RStudio installed

- PostgreSQL database already created
  - Example: TCSI_Extract_DB
  - Ensure the database user (e.g., postgres) has the correct permissions to connect and run queries
  
- Required R packages: DBI, RPostgres, dplyr, readr, writexl
  Install them once in your R console using:
  ```r
  install.packages(c("DBI", "RPostgres", "dplyr", "readr", "writexl"),
                   repos = "https://cloud.r-project.org/")
  ```

- Optional: Ensure network/firewall rules allow access to the PostgreSQL server if it’s remote.


### Environment Variables
Database credentials should be stored securely in a .Renviron file to avoid hardcoding sensitive information.
See the “Setup_Guide.pdf” for detailed instructions on creating this file for Windows, Mac, and Linux.

Create a `.Renviron` file with the following contents:
```
DB_HOST=localhost           # Database server IP or hostname
DB_PORT=5432                # Default PostgreSQL port
DB_NAME=TCSI_Extract_DB     # Database name
DB_USER=postgres            # Username
DB_PASSWORD=<your_password> # Database password
```

*Notes:*

- Replace `<your_password>` with your actual password
- On Windows, save it in `C:/Users/<username>/Documents/.Renviron` (ensure "All files" type).
- On Mac/Linux, save it in your home directory `~/.Renviron`.

*Verify in R:*

```{r, echo=TRUE, results='hide'}
Sys.getenv("DB_HOST")
Sys.getenv("DB_PASSWORD")
```

If the values print correctly, `.Renviron` is working.

### Setup: Load Libraries and DB Parameters

Load the installed libraries into the R session so their functions are available for database operations, data manipulation, and file handling.

```{r}
library(DBI)
library(RPostgres)
library(dplyr)
library(readr)
library(writexl)
```

Define the database connection parameters by reading the values stored in the `.Renviron` file.
These variables will be used to securely connect to the PostgreSQL database.

```{r}
db_config <- list(
  host = Sys.getenv("DB_HOST"),
  port = as.integer(Sys.getenv("DB_PORT")),
  dbname = Sys.getenv("DB_NAME"),
  user = Sys.getenv("DB_USER"),
  password = Sys.getenv("DB_PASSWORD")
)
```

### Database Connection Function

Define a function to establish a connection to the PostgreSQL database with informative messages if the connection fails:

```{r}
create_db_connection <- function() {
  tryCatch({
    con <- dbConnect(
      RPostgres::Postgres(),
      host = db_config$host,
      port = db_config$port,
      dbname = db_config$dbname,
      user = db_config$user,
      password = db_config$password
    )
    message("Database connection successful!")
    return(con)
  }, error = function(e) {
    stop("Connection failed: ", e$message)
  })
}
```

### Helper Function: `run_query`

Define a helper function that executes SQL queries against the database.
Execute SQL queries safely, automatically opening and closing the connection:

```{r}
run_query <- function(query) {
  con <- create_db_connection()
  on.exit(dbDisconnect(con), add = TRUE)
  dbGetQuery(con, query)
}
```


### Test Connection & Examples

Test your connection and the `run_query()` function. Query outputs are hidden in this document to avoid exposing real data. You can run them in your R session to view results.

```{r, echo=TRUE, results='hide'}
# Create a connection and list all tables
db_conn <- create_db_connection()
dbListTables(db_conn)
dbDisconnect(db_conn)

# Example query using run_query
run_query("SELECT * FROM students LIMIT 5;")
```

### Notes & Recommendations

- Always ensure `.Renviron` is correctly configured before running queries.
- `run_query()` automatically closes connections to avoid leaving open sessions.
- For more advanced queries, you may use the `query_table()` function (see `query_table_doc.Rmd`) which supports filtering, aggregation, ordering, and limiting results.

### Session Info
```{r}
sessionInfo()
```
